# CompreFace CCTV Integration - Visual Architecture Guide

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SPi CCTV Monitoring System                           â”‚
â”‚                         (React + TypeScript)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   DataInput_Integrated.tsx     â”‚
                    â”‚   âœ… CCTV Video Upload Tab     â”‚
                    â”‚   â”œâ”€ Upload CCTV Video        â”‚
                    â”‚   â”œâ”€ Select Sample Rate        â”‚
                    â”‚   â””â”€ Trigger Analysis         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ HTTP POST
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  POST /api/v1/cctv/analyze-video        â”‚
                â”‚  (Backend API Endpoint)                  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          Backend FastAPI (app.py)                      â”‚
        â”‚  Initializes CompreFace and Video Processor Modules    â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
             â”‚                                                â”‚
             â”‚                                                â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ CompreFaceIntegration  â”‚                  â”‚ CCTVVideoProcessor         â”‚
   â”‚ (New Backend Module)   â”‚                  â”‚ (New Backend Module)       â”‚
   â”‚                        â”‚                  â”‚                           â”‚
   â”‚ âœ… Client for REST API â”‚                  â”‚ âœ… Process video frames   â”‚
   â”‚ âœ… Face Detection      â”‚                  â”‚ âœ… Batch processing       â”‚
   â”‚ âœ… Face Recognition    â”‚                  â”‚ âœ… Real-time support      â”‚
   â”‚ âœ… Anomaly Detection   â”‚                  â”‚ âœ… Threat calculation     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                   â”‚
            â”‚                                   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                          â”‚                  â”‚
                          â–¼                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     CompreFace Service (Docker)              â”‚
        â”‚     ğŸ”Œ http://localhost:8000                 â”‚
        â”‚                                              â”‚
        â”‚  â”œâ”€ Face Detection API                       â”‚
        â”‚  â”‚  â””â”€ POST /api/v1/detection/detect        â”‚
        â”‚  â”‚     Returns: {box, confidence}            â”‚
        â”‚  â”‚                                           â”‚
        â”‚  â”œâ”€ Face Recognition API                     â”‚
        â”‚  â”‚  â””â”€ POST /api/v1/recognition/recognize   â”‚
        â”‚  â”‚     Returns: {embeddings}                 â”‚
        â”‚  â”‚                                           â”‚
        â”‚  â””â”€ Additional Services                      â”‚
        â”‚     â””â”€ Face verification, mask detection    â”‚
        â”‚                                              â”‚
        â”‚  Backend Services:                           â”‚
        â”‚  â”œâ”€ compreface-admin (port 8080)            â”‚
        â”‚  â”œâ”€ compreface-api (port 8000)              â”‚
        â”‚  â””â”€ compreface-postgres-db                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  Docker Network  â”‚
                â”‚  Internal Comms  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Diagrams

### Video Analysis Pipeline

```
CCTV Video File (MP4)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Frame Extraction      â”‚
â”‚ âœ… Extract every Nth frame (configurable)
â”‚ âœ… Resize to 640x480      â”‚
â”‚ âœ… Create frame queue     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ Frames List
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Batch Face Detection          â”‚
â”‚ For each frame:                  â”‚
â”‚  âœ… Send to CompreFace API       â”‚
â”‚  âœ… Get face coordinates         â”‚
â”‚  âœ… Filter by confidence (>0.5)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ Detections
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Face Recognition              â”‚
â”‚ For each detected face:          â”‚
â”‚  âœ… Extract face region          â”‚
â”‚  âœ… Get embedding vector         â”‚
â”‚  âœ… Compare with known faces     â”‚
â”‚  âœ… Calculate similarity         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ Recognition Results
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Anomaly Detection             â”‚
â”‚ For each recognition:            â”‚
â”‚  âœ… Check risk_score             â”‚
â”‚  âœ… Compare with thresholds      â”‚
â”‚  âœ… Check zone authorization     â”‚
â”‚  âœ… Flag if anomaly found        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ Anomalies
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Integrate with CSV Data       â”‚
â”‚  âœ… Load employee data           â”‚
â”‚  âœ… Correlate with detections    â”‚
â”‚  âœ… Enhance with context         â”‚
â”‚  âœ… Calculate combined risk      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ Enriched Results
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Generate Analysis Report      â”‚
â”‚  âœ… Summary statistics           â”‚
â”‚  âœ… Threat level                 â”‚
â”‚  âœ… High-risk employees          â”‚
â”‚  âœ… Unauthorized access          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ Final Report
             â”‚
             â–¼
        Results UI
        â”œâ”€ Display detections
        â”œâ”€ Show anomalies
        â”œâ”€ Alert on threats
        â””â”€ Export PDF
```

### Real-time Frame Analysis

```
CCTV Stream / Live Frame
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Receive Frame (JPEG/PNG)  â”‚
â”‚ âœ… Decode image           â”‚
â”‚ âœ… Validate format        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Image Data
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Send to CompreFace         â”‚
â”‚ âœ… API call (POST)         â”‚
â”‚ âœ… Timeout protection      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Detections
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Process Detections         â”‚ Compare with Known     â”‚
â”‚ âœ… Get coordinates         â”‚ âœ… Get embeddings      â”‚
â”‚ âœ… Filter low conf         â”‚ âœ… Calculate similarityâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ Recognition + Detection
                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Check Context  â”‚
                    â”œâ”€ Current zone? â”‚
                    â”œâ”€ Risk score?   â”‚
                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Determine Status    â”‚
                â”œâ”€ GRANTED           â”‚
                â”œâ”€ DENIED            â”‚
                â”œâ”€ SUSPICIOUS        â”‚
                â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ Access Status
                      â”‚
                      â–¼
                Real-time Alert
                â”œâ”€ Display if threat
                â”œâ”€ Log event
                â””â”€ Update dashboard
```

## Anomaly Detection Decision Tree

```
Detected Person
      â”‚
      â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Employee in     â”‚
  â”‚ authorized_zone?â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                     â”‚
       â–¼                                     â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Risk Score > 70?         â”‚      â”‚ Zone Authorized?   â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                               â”‚        â”‚
       â”œâ”€ YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ YES    â”‚ NO
       â”‚                            â”‚  â”‚        â”‚
       â”‚                            â–¼  â–¼        â–¼
       â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                      â”‚ GRANTED      â”‚ â”‚ SUSPICIOUS
       â”‚                      â”‚ Access âœ…    â”‚ â”‚ Access âš ï¸
       â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ NO â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HIGH_RISK_       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚DETECTED Flag    â”‚                 â”‚
â”‚ Risk Score      â”‚                 â”‚ Anomaly!
â”‚ > 70 = ANOMALY  â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
       â”‚                             â”‚
       â–¼                             â–¼
 Flag with context           Store Anomaly
 â”œâ”€ Employee ID              â”œâ”€ Type
 â”œâ”€ Risk Score               â”œâ”€ Employee
 â”œâ”€ Frame Index              â”œâ”€ Risk Score
 â””â”€ Timestamp                â”œâ”€ Confidence
                             â””â”€ Frame Info
```

## Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Frontend (React)                      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ DataInput    â”‚  â”‚ CCTVMonitoringâ”‚  â”‚ Results      â”‚ â”‚
â”‚  â”‚ _Integrated  â”‚â—„â”€â”¤              â”‚  â”‚              â”‚ â”‚
â”‚  â”‚              â”‚  â”‚ Real-time    â”‚â”€â”€â”¤ Shows CCTV   â”‚ â”‚
â”‚  â”‚ Upload Video â”‚  â”‚ Detection    â”‚  â”‚ Analysis     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                              â”‚
â”‚         â”‚ HTTP POST                                    â”‚
â”‚         â”‚ /api/v1/cctv/analyze-video                  â”‚
â”‚         â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Backend (Python/FastAPI)                  â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ app.py - Main FastAPI Application               â”‚  â”‚
â”‚  â”‚                                                  â”‚  â”‚
â”‚  â”‚  âœ… Initialize CompreFace Client                â”‚  â”‚
â”‚  â”‚  âœ… Initialize Video Processor                  â”‚  â”‚
â”‚  â”‚  âœ… Define 3 new endpoints                      â”‚  â”‚
â”‚  â”‚  âœ… Error handling & fallbacks                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚              â”‚              â”‚                 â”‚
â”‚         â–¼              â–¼              â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚CompreFace  â”‚ â”‚CCTV Video  â”‚ â”‚Risk        â”‚         â”‚
â”‚  â”‚Integration â”‚ â”‚Processor   â”‚ â”‚Scoring     â”‚         â”‚
â”‚  â”‚            â”‚ â”‚            â”‚ â”‚Engine      â”‚         â”‚
â”‚  â”‚â”œâ”€Detect    â”‚ â”‚â”œâ”€Extract   â”‚ â”‚â”œâ”€Calc Risk â”‚         â”‚
â”‚  â”‚â”œâ”€Recognize â”‚ â”‚â”œâ”€Process   â”‚ â”‚â”œâ”€Check CSV â”‚         â”‚
â”‚  â”‚â”œâ”€Analyze   â”‚ â”‚â”œâ”€Analyze   â”‚ â”‚â”œâ”€Find      â”‚         â”‚
â”‚  â”‚â”œâ”€Match     â”‚ â”‚â””â”€Threat    â”‚ â”‚â”‚ Anomalies â”‚         â”‚
â”‚  â”‚â””â”€Extract   â”‚ â”‚  Calculate â”‚ â”‚â””â”€Combine   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚              â”‚              â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜                 â”‚
â”‚                    â–¼              â–¼                     â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚ Enrich Results with Data      â”‚             â”‚
â”‚         â”‚ â”œâ”€ Merge CSV behavioral data  â”‚             â”‚
â”‚         â”‚ â”œâ”€ Calculate combined risk    â”‚             â”‚
â”‚         â”‚ â”œâ”€ Generate summary           â”‚             â”‚
â”‚         â”‚ â””â”€ Format response            â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                    â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ JSON Response
                     â”‚ { analysis, summary, anomalies }
                     â”‚
                     â–¼
              Frontend Displays
              â”œâ”€ Detections
              â”œâ”€ Threats
              â”œâ”€ Risk scores
              â””â”€ Options to export
```

## State Flow Diagram

```
Initial State: IDLE
        â”‚
        â–¼
User Action: Upload Video
        â”‚
        â–¼
State: PROCESSING
â”œâ”€ ğŸ”„ Extracting Frames (Step 1/6)
â”œâ”€ ğŸ”„ Detecting Faces (Step 2/6)
â”œâ”€ ğŸ”„ Recognizing Faces (Step 3/6)
â”œâ”€ ğŸ”„ Detecting Anomalies (Step 4/6)
â”œâ”€ ğŸ”„ Integrating Data (Step 5/6)
â””â”€ ğŸ”„ Generating Report (Step 6/6)
        â”‚
        â”œâ”€ Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                        â”‚
        â””â”€ Error â”€â”€â”€â”€â”€â”€â”€â”        â”‚
                        â”‚        â”‚
                        â–¼        â–¼
               Fallback Mode   Analysis Complete
               â”œâ”€ Demo Results â”‚
               â””â”€ Show         â””â”€ State: COMPLETE
                  Warning         â”‚
                                 â–¼
                         Results Displayed
                         â”œâ”€ Face Detections
                         â”œâ”€ Recognitions
                         â”œâ”€ Anomalies
                         â”œâ”€ Threat Level
                         â””â”€ Export Options
                                â”‚
                                â–¼
                         State: IDLE (Ready for next)
```

## Information Flow Diagram (Data Types)

```
Video Input
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ List[np.ndarray]            â”‚ Extracted Frames
â”‚ - Shape: (H, W, 3)          â”‚ (BGR)
â”‚ - Count: variable           â”‚
â”‚ - Metadata: fps, duration   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ List[FaceDetection]         â”‚ Detected Faces
â”‚ - x, y, width, height       â”‚ (Coordinates)
â”‚ - confidence: 0-1           â”‚
â”‚ - Per frame: 0-N faces      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ List[RecognitionResult]     â”‚ Recognized Persons
â”‚ - face_id                   â”‚
â”‚ - employee_id               â”‚
â”‚ - confidence: 0-1           â”‚
â”‚ - box: FaceDetection        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dict[anomalies]             â”‚ Anomaly List
â”‚ - type: str                 â”‚
â”‚ - employee_id               â”‚
â”‚ - risk_score: 0-100         â”‚
â”‚ - confidence                â”‚
â”‚ - frame_index               â”‚
â”‚ - Count: 0-M anomalies      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VideoAnalysisResult             â”‚
â”‚ - total_frames: int             â”‚
â”‚ - faces_detected: int           â”‚
â”‚ - faces_recognized: int         â”‚
â”‚ - anomalies_count: int          â”‚
â”‚ - anomalies: List[Dict]         â”‚
â”‚ - summary: Dict with stats      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JSON Response to Frontend       â”‚
â”‚ {                               â”‚
â”‚   "status": "success",          â”‚
â”‚   "video_analysis": {...},      â”‚
â”‚   "summary": {...}              â”‚
â”‚ }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Zone Access Decision Matrix

```
Zone: CEO Executive Suite
Authorized Users: [AAE0190, AAF0535]

Detection: Employee AAE0190
â”œâ”€ In Authorization List? YES
â”œâ”€ Risk Score: 64.02
â”œâ”€ Risk > 70? NO
â”œâ”€ Access Status: âœ… GRANTED
â””â”€ Anomaly: None

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Zone: Financial Records Vault
Authorized Users: [ABC0174, AAE0190]

Detection: Employee AAF0535
â”œâ”€ In Authorization List? NO
â”œâ”€ Risk Score: 77.37
â”œâ”€ Risk > 60? YES
â”œâ”€ Access Status: ğŸš« DENIED
â””â”€ Anomaly: âœ… UNAUTHORIZED_ZONE_ACCESS
   â””â”€ Type: Unauthorized + High Risk

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Zone: R&D Lab
Authorized Users: [AAF0535, ABC0174]

Detection: Employee LOW0001
â”œâ”€ In Authorization List? NO
â”œâ”€ Risk Score: 12.5
â”œâ”€ Risk > 60? NO
â”œâ”€ Access Status: âš ï¸ ADVISORY
â””â”€ Anomaly: None (low risk)
   â””â”€ Note: Unauthorized but low risk
```

## Performance Timeline Example

```
Video: 1 minute @ 25 FPS = 1500 frames
Sample rate: 5 = 300 frames to process
Resolution: 640x480

Timeline:
â”œâ”€ 0-2s: Video loading & frame extraction
â”œâ”€ 2-4s: Frame resizing & preprocessing
â”œâ”€ 4-6s: Face detection (300 frames Ã— 2 API calls/frame)
â”œâ”€ 6-8s: Face recognition & embedding
â”œâ”€ 8-9s: Anomaly detection analysis
â”œâ”€ 9-10s: CSV data integration & enrichment
â”œâ”€ 10-11s: Report generation & formatting
â””â”€ 11s: Delivery to frontend

Total: ~11 seconds (with GPU acceleration)
Total: ~18 seconds (CPU fallback)
```

---

Visual guides created: âœ…
Architecture documented: âœ…
Data flow illustrated: âœ…
Ready for use: âœ…

